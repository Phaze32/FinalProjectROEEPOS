var Autocomplete=function(e,t){this.el=$(e);this.id=this.el.identify();this.el.setAttribute("autocomplete","off");this.suggestions=[];this.suggestionsPaths=[];this.suggestionsPrice=[];this.specialPrices=[];this.suggestionsProductIds=[];this.suggestBrands=[];this.suggestCategories=[];this.suggestKeywords=[];this.productTypes=[];this.suggestKeywordsRaw=[];this.manager=t.manager;this.ajaxBaseUrl=null;this.queryFields=null;this.incorrectkeywords=[];this.Autocompletemessage=null;this.didyoumeantext="";this.timestamp=0;this.data=[];this.badQueries=[];this.selectedIndex=-1;this.selectedItemIndex=0;this.selectedProductId=null;this.currentValue=this.el.value;this.currentKeyword=null;this.intervalId=0;this.cachedResponse=[];this.instanceId=null;this.onChangeInterval=null;this.ignoreValueChange=false;this.serviceUrl=t.serviceUrl;this.options={autoSubmit:false,minChars:1,maxHeight:300,deferRequestBy:0,width:0,container:null,allowFilter:0,currencySign:"$",displayThumb:0};if(t){Object.extend(this.options,t)}if(Autocomplete.isDomLoaded){this.initialize()}else{Event.observe(document,"dom:loaded",this.initialize.bind(this),false)}};Autocomplete.instances=[];Autocomplete.isDomLoaded=false;Autocomplete.getInstance=function(e){var t=Autocomplete.instances;var n=t.length;while(n--){if(t[n].id===e){return t[n]}}};Autocomplete.highlight=function(e,t){e=e.toString();return e.replace(t,function(e){return"<strong>"+e+"</strong>"})};Autocomplete.prototype={killerFn:null,initialize:function(){var e=this;this.killerFn=function(t){if(!$(Event.element(t)).up(".autocomplete")){e.killSuggestions();e.disableKillerFn()}}.bindAsEventListener(this);if(!this.options.width){this.options.width=this.el.getWidth()}this.box=new Element("div",{style:"position:absolute;display:none;z-index:99999"});var t=(new Element("div",{id:"sbs_"+this.id+"_autocomplete_box"})).addClassName("sbs_autocomplete_inner");var n=(new Element("div",{id:"sbs_"+this.id+"_autocomplete_right"})).addClassName("sbs_autocomplete_inner_right");t.appendChild(n);var r=(new Element("div",{id:"sbs_"+this.id+"_autocomplete_left"})).addClassName("sbs_autocomplete_inner_left");t.appendChild(r);var i=(new Element("div",{id:"sbs_"+this.id+"_closed_button"})).addClassName("sbs_autocomplete_close_button").update("&nbsp;");t.appendChild(i);this.box.appendChild(t);this.options.container=$(this.options.container);document.body.appendChild(this.box);this.divId=this.box.identify();this.rightSideBar=$("sbs_"+this.id+"_autocomplete_right");this.container=$("sbs_"+this.id+"_autocomplete_box");this.closebutton=$("sbs_"+this.id+"_closed_button");this.leftSideBar=$("sbs_"+this.id+"_autocomplete_left");if(this.options.sideBarWidth){this.leftSideBar.setStyle({width:"100%"})}if(this.options.boxWidth){this.container.setStyle({width:this.options.boxWidth+"px"})}this.container.setStyle({padding:"0"});if(this.options.allowFilter==1){this.leftSideBar.show()}else{this.leftSideBar.remove()}this.fixPosition();Event.observe(this.el,window.opera?"keypress":"keydown",this.onKeyPress.bind(this));Event.observe(this.el,"keyup",this.onKeyUp.bind(this));Event.observe(this.el,"click",this.onClick.bind(this));Event.observe(this.el,"blur",this.enableKillerFn.bind(this));Event.observe(this.el,"focus",this.fixPosition.bind(this));Event.observe(this.closebutton,"click",this.closeAll.bind(this));Event.observe(window,"resize",this.fixPosition.bind(this));this.instanceId=Autocomplete.instances.push(this)-1},closeAll:function(){this.hide()},hide:function(){this.box.hide()},show:function(){this.box.show()},fixPosition:function(){this.el.setStyle({background:"#fff"});var e=this.el.cumulativeOffset();var t=e.top+this.el.getHeight();var n=document.viewport.getDimensions();var r=n.width;var i=this.el.getWidth()-5;if(parseInt(this.options.boxWidth)>0&&parseInt(r)>=parseInt(this.options.boxWidth)){i=this.options.boxWidth;var s=e.left-parseInt(this.options.boxWidth)+this.el.getWidth()-10}else{i=this.el.getWidth()-5;var s=e.left}var o=r-i;if(o<0){i=this.el.getWidth()-5;var s=e.left}this.container.setStyle({width:i+"px"});$(this.box).setStyle({top:t+"px",left:s+"px"});this.closebutton.setStyle({top:"-10px",left:i-12+"px"})},enableKillerFn:function(){Event.observe(document.body,"click",this.killerFn)},disableKillerFn:function(){Event.stopObserving(document.body,"click",this.killerFn)},killSuggestions:function(){this.stopKillSuggestions();this.intervalId=window.setInterval(function(){this.hide();this.stopKillSuggestions()}.bind(this),1)},stopKillSuggestions:function(){window.clearInterval(this.intervalId)},onKeyPress:function(e){if(!this.enabled){return}switch(e.keyCode){case Event.KEY_ESC:this.el.value=this.currentValue;this.hide();break;case Event.KEY_TAB:case Event.KEY_RETURN:if(this.selectedIndex===-1){this.hide();return}this.enterSelect(this.selectedItemIndex);if(e.keyCode===Event.KEY_TAB){return}break;case Event.KEY_UP:this.moveUp();break;case Event.KEY_DOWN:this.moveDown();break;default:return}Event.stop(e)},onKeyUp:function(e){switch(e.keyCode){case Event.KEY_UP:case Event.KEY_DOWN:return}clearInterval(this.onChangeInterval);if(this.currentValue!==this.el.value){if(this.options.deferRequestBy>0){this.onChangeInterval=setInterval(function(){this.onValueChange()}.bind(this),this.options.deferRequestBy)}else{this.onValueChange()}}},onValueChange:function(){clearInterval(this.onChangeInterval);this.currentValue=this.el.value;this.selectedIndex=-1;if(this.ignoreValueChange){this.ignoreValueChange=false;return}this.suggestions=[];if(this.currentValue===""||this.currentValue.length<this.options.minChars){this.hide()}else{this.manager.store.remove("fq");this.getSuggestions()}},onClick:function(){this.suggestions=[];if(this.currentValue===""||this.currentValue.length<this.options.minChars){this.hide()}else{this.manager.store.remove("fq");this.getSuggestions()}},getSuggestions:function(){if(this.currentValue==this.options.searchTextPlaceHolder){return false}this.manager.store.addByValue("q",this.currentValue);this.manager.store.addByValue("storeid",this.options.storeid);this.manager.store.addByValue("customergroupid",this.options.customergroupid);this.manager.store.addByValue("storetimestamp",this.options.storetimestamp);this.manager.store.addByValue("currencycode",this.options.currencycode);var e=(new Date).getTime();this.manager.store.addByValue("timestamp",e);this.timestamp=e;this.manager.doRequest()},isBadQuery:function(e){var t=this.badQueries.length;while(t--){if(e.indexOf(this.badQueries[t])===0){return true}}return false},formatPrice:function(e){var t=e;if(e!==undefined&&e!==null){if(this.options.currencyPos=="before"){t=this.options.currencySign+e}else{t=e+this.options.currencySign}}else{t="&nbsp;"}return t},suggest:function(){if(this.suggestions.length===0&&this.currentValue.length==0){this.hide();this.container.hide();return}var e=[];var t=-1;for(key in this.suggestions){if(!isNaN(key)){var n=this.suggestions[key];var r=this.suggestionsPrice[key];var i=this.specialPrices[key];var s=this.formatPrice(r);var o=this.formatPrice(i);if(this.productTypes[key]=="bundle"){s=this.options.fromPriceText+"&nbsp;"+s;o=this.options.fromPriceText+"&nbsp;"+s}var u="sbs_"+this.id+"_suggest_index_"+key;var a=this.selectedIndex===t?"product suggested-item":"product suggested-item";var f='<div class="sbs_search_suggest_thumb"><img src="'+this.options.ajaxBaseUrl+"/media/catalog/product/sb_thumb/"+this.suggestionsProductIds[key]+'.jpg"/></div>';if(parseInt(i)>0){var l='<span class="sbs_search_suggest_item_subtitle old-price">'+s+"</span>";l+='<span class="sbs_search_suggest_item_subtitle special-price">'+o+"</span>"}else{var l='<span class="sbs_search_suggest_item_subtitle">'+s+"</span>"}var c='<span class="sbs_search_suggest_item_title">'+n+"</span>";if(this.options.displayThumb==1){var h=(new Element("div",{id:u,title:n})).addClassName(a).update(f+c+"<br/>"+l+"<br/>");Event.observe(h,"click",this.select.bind(this,key,h));Event.observe(h,"mouseout",this.onMouseOut.bind(this,h));Event.observe(h,"mouseover",this.onMouseOver.bind(this,h));e.push(h)}else{var h=(new Element("div",{id:u,title:n})).addClassName(a).update(c+"<br/>"+l+"<br/>");Event.observe(h,"click",this.select.bind(this,key,h));Event.observe(h,"mouseout",this.onMouseOut.bind(this,h));Event.observe(h,"mouseover",this.onMouseOver.bind(this,h));e.push(h)}t++}}this.enabled=true;this.container.setStyle("display:block");if(this.suggestions.length>0){this.rightSideBar.update('<div class="suggest_product_items suggest_divider sbs_autocomplete_message">'+this.Autocompletemessage+"</div>");if(this.options.displaykeywordsuggestion&&this.suggestKeywords.length>0){for(var p in this.suggestKeywords){if(!isNaN(p)){var d=this.suggestKeywords[p];var v=this.suggestKeywordsRaw[p];var m=(new Element("div",{id:"sbs_"+this.id+"_keyword_index_"+p,style:"cursor:pointer;",onclick:"Autocomplete.instances["+this.instanceId+"].select("+p+", this)",onmouseover:'$(this).addClassName("selected")',onmouseout:'$(this).removeClassName("selected")'})).addClassName("keywords suggested-item");m.update('<span class="sbs_search_suggest_item_title">'+d+"</span>");this.rightSideBar.appendChild(m)}}this.rightSideBar.appendChild((new Element("div")).addClassName("suggest_category_items suggest_divider").update(this.options.productsText))}var g=this.rightSideBar;e.each(function(e){g.appendChild(e)});if(parseInt(this.options.showBrand)>0&&this.suggestBrands.length>0){var y=this.options.searchResultUrl+"/by/brand";var b=(new Element("span")).addClassName("view-all-brand").update('<a href="'+y+'">'+this.options.viewAllBrandsText+"</a>");var w=(new Element("div")).addClassName("suggest_category_items suggest_divider");var E=(new Element("span")).update(this.options.brandText);w.appendChild(E);w.appendChild(b);this.rightSideBar.appendChild(w);var S=1;for(key_brand in this.suggestBrands){if(!isNaN(key_brand)){var x=this.suggestBrands[key_brand][0];var T=this.suggestBrands[key_brand][1];var N=T+"&nbsp;"+this.options.productText;if(parseInt(T)>1){N=T+"&nbsp;"+this.options.productsText}var C=new RegExp("\\b"+this.currentKeyword.match(/\w+/g).join("|\\b"),"gi");var k=Autocomplete.highlight(x,C);var L=(new Element("div",{id:"sbs_"+this.id+"_brand_index_"+key_brand,style:"cursor:pointer;",onclick:"Autocomplete.instances["+this.instanceId+"].select("+key_brand+", this)",onmouseover:'$(this).addClassName("selected")',onmouseout:'$(this).removeClassName("selected")'})).addClassName("brand suggested-item");L.update('<span class="sbs_search_suggest_item_title">'+k+'</span><br/><span class="sbs_search_suggest_item_subtitle">'+N+"</span>");this.rightSideBar.appendChild(L);if(S>=parseInt(this.options.brandLimit))break;S++}}}if(this.suggestCategories.length>0){var A=this.options.searchResultUrl+"/by/category";var O=(new Element("span")).addClassName("view-all-category").update('<a href="'+A+'">'+this.options.viewAllCategoryText+"</a>");var M=(new Element("div")).addClassName("suggest_category_items suggest_divider");var _=(new Element("span")).update(this.options.categoryText);M.appendChild(_);M.appendChild(O);this.rightSideBar.appendChild(M);var D=1;for(key_cat in this.suggestCategories){if(!isNaN(key_cat)){var P=this.suggestCategories[key_cat][0];var H=P.split("/");var B=[];for(var j=0;j<H.length;++j){if(j%2==0){B.push(H[j])}}catPath=B.join("&nbsp;>&nbsp;");catPath=catPath.replace(/_._._/g,"/");var C=new RegExp("\\b"+this.currentKeyword.match(/\w+/g).join("|\\b"),"gi");var F=Autocomplete.highlight(catPath,C);var T=this.suggestCategories[key_cat][1];var N=T+"&nbsp;"+this.options.productText;if(parseInt(T)>1){N=T+"&nbsp;"+this.options.productsText}var I=(new Element("div",{id:"sbs_"+this.id+"_category_index_"+key_cat,style:"cursor:pointer;",onclick:"Autocomplete.instances["+this.instanceId+"].select("+key_cat+", this)",onmouseover:'$(this).addClassName("selected")',onmouseout:'$(this).removeClassName("selected")'})).addClassName("category suggested-item");I.update('<span class="sbs_search_suggest_item_title">'+F+'</span><br/><span class="sbs_search_suggest_item_subtitle">'+N+"</span>");this.rightSideBar.appendChild(I);if(D>=parseInt(this.options.categoryLimit))break;D++}}}if(!document.getElementById("sbs_"+this.id+"_view_all_link")){var q=(new Element("div")).addClassName("sbs_search_autocomplete_box_bottom");q.update('<span id="sbs_'+this.id+'_view_all_link"></span>');this.container.appendChild(q)}var R=this.options.searchResultUrl+"?q="+this.currentKeyword;$("sbs_"+this.id+"_view_all_link").update('<a href="'+encodeURI(R)+'">'+this.options.viewAllResultText.replace("%s","<b>"+this.currentKeyword+"</b>"));this.show();return}else{this.hide();return}},processResponse:function(e){this.suggestions=[];if(typeof e==="undefined"&&this.currentValue.length==0){this.hide();return}if(e&&(e.response.docs.length<1||this.currentValue.length==0||e.responseHeader.params.timestamp!=this.timestamp)){this.hide();return}var t=0;if(e&&e.responseHeader.params.q){var n=e.responseHeader.params.q;this.suggestionsPaths=[];this.suggestions=[];this.suggestionsProductIds=[];for(var r=0;r<e.response.docs.length;++r){product_id=e.response.docs[r].products_id;this.suggestions[t]=e.response.docs[r].name_varchar;this.suggestionsPrice[t]=e.response.docs[r].price_decimal;this.specialPrices[t]=e.response.docs[r].special_price_decimal;this.productTypes[t]=e.response.docs[r].product_type_static;this.suggestionsPaths[t]=e.response.docs[r].url_path_varchar;this.suggestionsProductIds[t]=product_id;t++;if(t>=20){break}}this.Autocompletemessage=this.options.displayResultOfText.replace("%s","<b>"+e.responseHeader.params.q+"</b>");if(e.responseHeader.params.q!=this.currentValue.toLowerCase()){this.Autocompletemessage=this.options.displayResultOfInsteadText.replace("%s","<b>"+e.responseHeader.params.q+"</b>")}this.currentKeyword=e.responseHeader.params.q;this.suggestCategories=[];var i=this.manager.response.facet_counts.facet_fields.category_path;var r=0;for(key in i){if(i[key]<1||isNaN(i[key])){continue}this.suggestCategories[t]=[key,i[key]];t++;if(r>=5){break}r++}this.suggestKeywords=[];this.suggestKeywords=this.manager.response.keywordssuggestions;this.suggestKeywordsRaw=[];this.suggestKeywordsRaw=this.manager.response.keywordsraw;if(this.options.showBrand&&typeof this.manager.response.facet_counts.facet_fields!=="undefined"){this.suggestBrands=[];for(key in this.manager.response.facet_counts.facet_fields){if(key==this.options.showBrandAttributeCode+"_facet"){var s=this.manager.response.facet_counts.facet_fields[key];var t=0;for(key in s){if(s[key]<1||isNaN(s[key])){continue}this.suggestBrands[t]=[key,s[key]];t++}break}}}}this.suggest()},redirectToUrl:function(e){window.location=e},redirectToProduct:function(e){window.location=this.options.searchResultUrl+"/ajax/product?productid="+e+"&currency="+this.options.currencycode},redirectToBrand:function(e){var t=this.options.searchResultUrl+"?q="+this.currentKeyword+"&fq["+this.options.showBrandAttributeCode+"]="+encodeURIComponent(e);window.location=t;return true},redirectToKeyword:function(e){var t=this.options.searchResultUrl+"?q="+encodeURIComponent(e);window.location=t;return true},redirectToCategory:function(e){var t=0;var n=e.lastIndexOf("/");var r=e.substring(t,n);var i=r.substring(r.lastIndexOf("/")+1,r.length);var s=e.substring(e.lastIndexOf("/")+1,e.length);if(parseInt(this.options.categoryRedirect)>0){window.location=this.options.searchResultUrl+"/ajax/category?cat_id="+s;return true}else{var o=this.options.searchResultUrl+"?q="+this.currentKeyword+"&fq[category]="+i+"&fq[category_id]="+s;window.location=o}return true},activate:function(e){var t=this.rightSideBar.childNodes;var n;if(this.selectedIndex!==-1&&t.length-1>this.selectedIndex){var r=t[this.selectedIndex].className+" suggested-item";r=r.split(" ");r=r.uniq();t[this.selectedIndex].className=r.join(" ");$(t[this.selectedIndex]).removeClassName("selected")}if(t[e]==="undefined"){return}if(t[e].id){this.selectedItemIndex=e}this.selectedIndex=e;if(this.selectedIndex!==-1&&t.length>this.selectedIndex){n=t[this.selectedIndex];var i=n.className+" selected";i=i.split(" ");i=i.uniq();n.className=i.join(" ")}return n},deactivate:function(e,t){e.removeClassName("selected");if(this.selectedIndex===t){this.selectedIndex=-1}},select:function(e,t){var n=this.rightSideBar.childNodes;var r=parseInt(e)+1;var i=this.suggestions[e];var s=t.id;if($(s).hasClassName("product")){var o=this.suggestionsProductIds[e];this.redirectToProduct(o)}else if($(s).hasClassName("category")){var i=this.suggestCategories[e][0];this.redirectToCategory(i)}else if($(s).hasClassName("brand")){var i=this.suggestBrands[e][0];this.redirectToBrand(i)}else if($(s).hasClassName("keywords")){var i=this.suggestKeywordsRaw[e];this.redirectToKeyword(i)}else{if($(s)!=undefined){var o=this.suggestionsProductIds[e];this.redirectToProduct(o);return}else{return}}return true},enterSelect:function(e){var t=this.rightSideBar.childNodes;var n=parseInt(e)+1;var r=this.suggestions[e];if(t[e]==="undefined"){return}var i=t[e].id;if(!i){return}e=i.substring(i.lastIndexOf("_")+1,i.length);var s=i;if($(s).hasClassName("product")){var o=this.suggestionsPaths[e];this.redirectToUrl(o)}else if($(s).hasClassName("category")){var r=this.suggestCategories[e][0];this.redirectToCategory(r)}else if($(s).hasClassName("brand")){var r=this.suggestBrands[e][0];this.redirectToBrand(r)}else{return;if($(s)!="undefined"){var o=this.suggestionsPaths[e];this.redirectToUrl(o);return}else{return}}return true},moveUp:function(){var e=0;for(key_product in this.suggestions){if(!isNaN(key_product)){e=e+1}}var t=0;for(key_brand in this.suggestBrands){if(!isNaN(key_brand)){t=t+1}}var n=0;for(key_cat in this.suggestCategories){if(!isNaN(key_cat)){n=n+1}}var r=e+t+n+2;if(this.selectedIndex===0){return}if(this.selectedIndex===0){this.rightSideBar.childNodes[0].className="";this.selectedIndex=-1;return}this.adjustScroll(this.selectedIndex-1)},moveDown:function(){var e=0;for(key_product in this.suggestions){if(!isNaN(key_product)){e=e+1}}var t=0;for(key_brand in this.suggestBrands){if(!isNaN(key_brand)){t=t+1}}var n=0;for(key_cat in this.suggestCategories){if(!isNaN(key_cat)){n=n+1}}var r=e+t+n+2;if(this.selectedIndex===r){return}this.adjustScroll(this.selectedIndex+1)},adjustScroll:function(e){var t=this.rightSideBar;var n=this.activate(e);var r=n.offsetTop;var i=t.scrollTop;var s=i+this.options.maxHeight-25;if(r<i){t.scrollTop=r}else if(r>s){t.scrollTop=r-this.options.maxHeight+25}},onSelect:function(e){(this.options.onSelect||Prototype.emptyFunction)(this.suggestions[e],this.data[e])},onMouseOut:function(e){$(e).removeClassName("selected").addClassName("suggested-item")},onMouseOver:function(e){$(e).addClassName("selected")}};Event.observe(document,"dom:loaded",function(){Autocomplete.isDomLoaded=true},false)